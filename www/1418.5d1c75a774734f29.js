"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[1418],{22413:(y,f,o)=>{o.d(f,{D:()=>g});var m=o(69808),r=o(93075),M=o(23349),u=o(5e3);let g=(()=>{class t{}return t.\u0275fac=function(_){return new(_||t)},t.\u0275mod=u.oAB({type:t}),t.\u0275inj=u.cJS({imports:[[m.ez,r.u5,M.Pc]]}),t})()},77129:(y,f,o)=>{o.d(f,{K:()=>g});var m=o(69808),r=o(93075),M=o(23349),u=o(5e3);let g=(()=>{class t{}return t.\u0275fac=function(_){return new(_||t)},t.\u0275mod=u.oAB({type:t}),t.\u0275inj=u.cJS({imports:[[m.ez,r.u5,r.UX,M.Pc]]}),t})()},8027:(y,f,o)=>{o.d(f,{w:()=>S});var m=o(70655),r=o(93075),M=o(49926),u=o(40872),g=o.n(u),t=o(5e3),a=o(23349),_=o(69808);const Z=["video"],C=["canvas"],O=["fileinput"],R=["search"];function I(c,v){if(1&c){const n=t.EpF();t.TgZ(0,"ion-button",28),t.NdJ("click",function(){return t.CHM(n),t.oxw().stopScan()}),t._UZ(1,"ion-icon",29),t.qZA()}}function D(c,v){if(1&c){const n=t.EpF();t.TgZ(0,"ion-button",30),t.NdJ("click",function(){return t.CHM(n),t.oxw().reset()}),t._UZ(1,"ion-icon",31),t.qZA()}}function U(c,v){1&c&&(t.TgZ(0,"div",32),t._UZ(1,"ion-icon",33),t.TgZ(2,"span"),t._uU(3,"Ingrese tipo pago"),t.qZA(),t.qZA())}let S=(()=>{class c{constructor(n,i,e,h,l,s,p){this.modalController=n,this.loadingCtrl=i,this.toastCtrl=e,this.authenticationService=h,this.ngZone=l,this.navParams=s,this.plt=p,this.scanActive=!1,this.scanResult=null,this.loading=null,this.title="AGM project",this.zoom=16,this.monto=0,this.userinfo=[],this.plt.is("ios")&&"standalone"in window.navigator&&window}dismissModal(){this.modalController.dismiss({data:"close"})}ngOnInit(){this.userinfo=this.authenticationService.getcopiauser(),this.tituloxx=this.navParams.get("title"),this.moneda=this.navParams.get("moneda"),this.monto=this.navParams.get("monto"),this.tipo=this.navParams.get("tipo"),this.tipo2=this.navParams.get("tipo2"),this.Form=new r.cw({tpago:new r.NI("",r.kI.required)}),this.Form.controls.tpago.setValue("Efectivo")}ngAfterViewInit(){this.canvasElement=this.canvas.nativeElement,this.canvasContext=this.canvasElement.getContext("2d"),this.videoElement=this.video.nativeElement,this.startScan()}showQrToast(){return(0,m.mG)(this,void 0,void 0,function*(){(yield this.toastCtrl.create({message:`Open ${this.scanResult}?`,position:"top",buttons:[{text:"Open",handler:()=>{window.open(this.scanResult,"_system","location=yes")}}]})).present()})}reset(){this.scanResult=null}stopScan(){this.scanActive=!1}startScan(){return(0,m.mG)(this,void 0,void 0,function*(){const n=yield navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});this.videoElement.srcObject=n,this.videoElement.setAttribute("playsinline",!0),this.loading=yield this.loadingCtrl.create({}),yield this.loading.present(),this.videoElement.play(),requestAnimationFrame(this.scan.bind(this))})}scan(){return(0,m.mG)(this,void 0,void 0,function*(){if(this.videoElement.readyState===this.videoElement.HAVE_ENOUGH_DATA){this.loading&&(yield this.loading.dismiss(),this.loading=null,this.scanActive=!0),this.canvasElement.height=this.videoElement.videoHeight,this.canvasElement.width=this.videoElement.videoWidth,this.canvasContext.drawImage(this.videoElement,0,0,this.canvasElement.width,this.canvasElement.height);const n=this.canvasContext.getImageData(0,0,this.canvasElement.width,this.canvasElement.height),i=g()(n.data,n.width,n.height,{inversionAttempts:"dontInvert"});if(i){this.scanActive=!1,this.scanResult=this.authenticationService.decryptvalue(i.data);const e=this.scanResult.split("\xb0");this.authenticationService.getReg(e[6],"compratokens",0).then(h=>{let l=[];if(l=h,this.authenticationService.decryptvalue(l[0].trama)+"\xb0"+l[0].tipo+"\xb0"+l[0]._id+"\xb0"+l[0].tipo===this.scanResult){const p={idempresa:e[0],idsuscriptor:{id:e[1],nombre:e[2]},tokencompra:l[0]._id,descripcion:"Compra de saldo",tipocompra:"saldo",nombre:e[2],monto:this.monto,monto2:this.monto,url:"",tpago:this.Form.controls.tpago.value,estado:"Facturado",bitacora:{idempresa:this.userinfo[0].idempresa._id,idafiliado:"",email:this.userinfo[0].email,permiso:"Crea",accion:"Compra de saldo"},idempresa0:this.userinfo[0].idempresa._id,idsuscriptor2:{id:this.userinfo[0]._id,nombre:this.userinfo[0].nombre}};p&&this.authenticationService.createReg("",p,"comprasaldos").then(d=>{const P={estado:20,cobroservicio:" "+e[2]+", Se ha acreditado  un monto de "+this.moneda+" "+this.monto,bitacora:{idempresa:this.userinfo[0].idempresa._id,idafiliado:"",email:this.userinfo[0].email,permiso:"Actualiza",accion:"acepta token "+e[6]}};P&&this.authenticationService.createReg(e[6],P,"compratokens").then(E=>{this.modalController.dismiss({data:"Se ha realizado una venta a: "+e[2]+"<br> Por un monto de "+this.moneda+" "+this.monto})},E=>{this.authenticationService.presentAlert(E.error,"Precauci\xf3n","")})},d=>{this.authenticationService.presentAlert(d.error,"Precauci\xf3n","")})}else this.authenticationService.presentAlert("Transacci\xf3n insegura","Precauci\xf3n","")},h=>{this.authenticationService.presentAlert("Transacci\xf3n insegura","Precauci\xf3n","")})}else this.scanActive&&requestAnimationFrame(this.scan.bind(this))}else requestAnimationFrame(this.scan.bind(this))})}captureImage(){this.fileinput.nativeElement.click()}handleFile(n){const i=n.item(0),e=new Image;e.onload=()=>{this.canvasContext.drawImage(e,0,0,this.canvasElement.width,this.canvasElement.height);const h=this.canvasContext.getImageData(0,0,this.canvasElement.width,this.canvasElement.height),l=g()(h.data,h.width,h.height,{inversionAttempts:"dontInvert"});if(l){this.scanResult=this.authenticationService.decryptvalue(l.data);const s=this.scanResult.split("\xb0");this.authenticationService.getReg(s[6],"compratokens",0).then(p=>{let d=[];if(d=p,this.authenticationService.decryptvalue(d[0].trama)+"\xb0"+d[0].tipo+"\xb0"+d[0]._id+"\xb0"+d[0].tipo===this.scanResult){if("trasferencia"===this.tipo&&this.monto!==s[4])return void this.authenticationService.presentAlert("El Monto no coincide con lo que el cliente programo.<br> El cliente quiere pagar: "+this.moneda+" "+s[4]+"<br> Se quiere cobrar: "+this.moneda+" "+this.monto,"Precauci\xf3n","");const E={idempresa:s[0],idsuscriptor:{id:s[1],nombre:s[2]},tokencompra:d[0]._id,descripcion:"Compra de saldo",tipocompra:"saldo",nombre:s[2],monto:this.monto,monto2:this.monto,url:"",tpago:this.Form.controls.tpago.value,estado:"Facturado",bitacora:{idempresa:this.userinfo[0].idempresa._id,idafiliado:"",email:this.userinfo[0].email,permiso:"Crea",accion:"Compra de saldo"},idempresa0:this.userinfo[0].idempresa._id,idsuscriptor2:{id:this.userinfo[0]._id,nombre:this.userinfo[0].nombre}};E&&this.authenticationService.createReg("",E,"comprasaldos").then(A=>{const T={estado:20,cobroservicio:" "+s[2]+", Se ha acreditado  un monto de "+this.moneda+" "+this.monto,bitacora:{idempresa:this.userinfo[0].idempresa._id,idafiliado:"",email:this.userinfo[0].email,permiso:"Actualiza",accion:"acepta token "+s[6]}};T&&this.authenticationService.createReg(s[6],T,"compratokens").then(b=>{this.modalController.dismiss({data:"Se ha realizado una "+this.tipo2+" a: "+s[2]+"<br> Por un monto de "+this.moneda+" "+this.monto})},b=>{this.authenticationService.presentAlert(b.error,"Precauci\xf3n","")})},A=>{this.authenticationService.presentAlert(A.error,"Precauci\xf3n","")})}else this.authenticationService.presentAlert("Transacci\xf3n insegura","Precauci\xf3n","")},p=>{this.authenticationService.presentAlert("Transacci\xf3n insegura","Precauci\xf3n","")})}},e.src=URL.createObjectURL(i)}closeModal(){return(0,m.mG)(this,void 0,void 0,function*(){this.modalController.dismiss({data:"close"})})}}return c.\u0275fac=function(n){return new(n||c)(t.Y36(a.IN),t.Y36(a.HT),t.Y36(a.yF),t.Y36(M.$),t.Y36(t.R0b),t.Y36(a.X1),t.Y36(a.t4))},c.\u0275cmp=t.Xpm({type:c,selectors:[["app-my-modalscanpay2"]],viewQuery:function(n,i){if(1&n&&(t.Gf(Z,5),t.Gf(C,5),t.Gf(O,5),t.Gf(R,5)),2&n){let e;t.iGM(e=t.CRH())&&(i.video=e.first),t.iGM(e=t.CRH())&&(i.canvas=e.first),t.iGM(e=t.CRH())&&(i.fileinput=e.first),t.iGM(e=t.CRH())&&(i.searchElementRef=e.first)}},decls:37,vars:12,consts:[[3,"translucent"],["color","primary"],["collapse","true","slot","end"],["title","Parar escaner","color","danger",3,"click",4,"ngIf"],["title","Reset","color","warning",3,"click",4,"ngIf"],["title","Iniciar escaner",3,"click"],["slot","icon-only","name","qr-code-outline"],["title","leer imagen qr de galeria",3,"click"],["slot","icon-only","name","image-outline"],[3,"click"],["slot","icon-only","name","close"],["size","small"],[1,"ion-padding",3,"fullscreen"],["type","file","accept","image/*;capture=camera","hidden","",3,"change"],["fileinput",""],[3,"formGroup"],[1,"input-item"],["position","floating"],["color","danger"],["formControlName","tpago"],["value","Efectivo"],[1,"error-container"],["class","error-message",4,"ngIf"],[1,"detail-title"],["width","100%",3,"hidden"],["video",""],["hidden",""],["canvas",""],["title","Parar escaner","color","danger",3,"click"],["slot","start","name","stop-circle-outline"],["title","Reset","color","warning",3,"click"],["slot","start","name","refresh-circle-outline"],[1,"error-message"],["name","information-circle-outline"]],template:function(n,i){1&n&&(t.TgZ(0,"ion-header",0),t.TgZ(1,"ion-toolbar",1),t.TgZ(2,"ion-buttons",2),t.YNc(3,I,2,0,"ion-button",3),t.YNc(4,D,2,0,"ion-button",4),t.TgZ(5,"ion-button",5),t.NdJ("click",function(){return i.startScan()}),t._UZ(6,"ion-icon",6),t.qZA(),t.TgZ(7,"ion-button",7),t.NdJ("click",function(){return i.captureImage()}),t._UZ(8,"ion-icon",8),t.qZA(),t.TgZ(9,"ion-button",9),t.NdJ("click",function(){return i.closeModal()}),t._UZ(10,"ion-icon",10),t.qZA(),t.qZA(),t.TgZ(11,"ion-title",11),t._uU(12),t.qZA(),t.qZA(),t.qZA(),t.TgZ(13,"ion-content",12),t.TgZ(14,"input",13,14),t.NdJ("change",function(h){return i.handleFile(h.target.files)}),t.qZA(),t.TgZ(16,"form",15),t.TgZ(17,"ion-item",16),t.TgZ(18,"ion-label",17),t._uU(19,"Tipo pago"),t.TgZ(20,"ion-text",18),t._uU(21,"*"),t.qZA(),t.qZA(),t.TgZ(22,"ion-select",19),t.TgZ(23,"ion-select-option",20),t._uU(24,"Efectivo"),t.qZA(),t.qZA(),t.qZA(),t.TgZ(25,"div",21),t.YNc(26,U,4,0,"div",22),t.qZA(),t.qZA(),t._UZ(27,"br"),t.TgZ(28,"h3",23),t._uU(29,"Monto a cobrar: "),t.TgZ(30,"strong"),t._uU(31),t.ALo(32,"currency"),t.qZA(),t.qZA(),t._UZ(33,"video",24,25),t._UZ(35,"canvas",26,27),t.qZA()),2&n&&(t.Q6J("translucent",!0),t.xp6(3),t.Q6J("ngIf",i.scanActive),t.xp6(1),t.Q6J("ngIf",i.scanResult),t.xp6(8),t.Oqu(i.tituloxx),t.xp6(1),t.Q6J("fullscreen",!0),t.xp6(3),t.Q6J("formGroup",i.Form),t.xp6(10),t.Q6J("ngIf",i.Form.get("tpago").hasError("required")&&(i.Form.get("tpago").dirty||i.Form.get("tpago").touched)),t.xp6(5),t.hij(" ",t.xi3(32,9,i.monto,i.moneda),""),t.xp6(2),t.Q6J("hidden",!i.scanActive))},directives:[a.Gu,a.sr,a.Sm,_.O5,a.YG,a.gu,a.wd,a.W2,r._Y,r.JL,r.sg,a.Ie,a.Q$,a.yW,a.t9,a.QI,r.JJ,r.u,a.n0],pipes:[_.H9],styles:["[_nghost-%COMP%]{--page-margin: var(--app-fair-margin);--page-background: var(--app-background);--page-swiper-pagination-space: 30px;--page-swiper-pagination-height: 18px;--page-pagination-bullet-size: 10px;--page-options-gutter: calc(var(--page-margin) / 2);--page-related-items-gutter: calc(var(--page-margin) / 2);--page-color: #089bdf}.book-search-input[_ngcontent-%COMP%]{padding:6px;background:0 0;transition:top .5s ease;background:#bdbaba;border-bottom:1px solid rgba(0,0,0,.07);border-top:1px solid rgba(0,0,0,.07);margin-bottom:10px;margin-top:-1px;color:#fff;width:100%}.detail-title[_ngcontent-%COMP%]{font-size:22px;font-weight:500;color:var(--ion-color-dark-tint);margin:0;margin-bottom:calc(var(--page-margin) / 2)}"]}),c})()}}]);